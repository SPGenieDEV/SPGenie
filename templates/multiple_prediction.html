<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Multiple Prediction</title>
</head>
<style>
    button {
        background-color: #4CAF50; /* green background */
        border: none; /* no border */
        color: white; /* white text */
        padding: 12px 24px; /* padding around the text */
        text-align: center; /* center the text horizontally */
        text-decoration: none; /* no underline */
        display: inline-block; /* display as inline block */
        font-size: 16px; /* font size */
        border-radius: 4px; /* rounded corners */
        cursor: pointer; /* change the cursor to a pointer on hover */
        transition: background-color 0.3s ease; /* transition for the background color */
    }

    button:hover {
        background-color: #3e8e41; /* darker green background on hover */
    }

    /* Style for the label */
    label {
        display: block;
        margin-bottom: 10px;
        font-size: 20px;
        font-weight: bold;
    }

    /* Style for the select element */
    select {
        display: block;
        width: 100%;
        padding: 12px 20px;
        border: none;
        border-radius: 4px;
        background-color: #f1f1f1;
        font-size: 16px;
        margin-bottom: 20px;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
    }

    /* Style for the select arrow */
    select::after {
        content: '\25BC';
        position: absolute;
        top: 50%;
        right: 20px;
        transform: translateY(-50%);
        color: #777;
    }

    /* Style for the select when it is open */
    select:focus {
        outline: none;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        background-color: #fff;
    }

    /* Style for the select options */
    select option {
        padding: 10px;
        font-size: 16px;
        border: none;
        border-radius: 4px;
        color: #333;
        background-color: #f1f1f1;
    }

    /* Style for the select options when hovered */
    select option:hover {
        background-color: #ddd;
    }

    .title {
        margin: 15px auto;
    }

    .title h2 {
        margin: 5px auto;
        text-align: center;

    }

    table {
        border-collapse: collapse;
        width: 100%;
        font-size: 14px;
        font-family: Arial, sans-serif;
        text-align: left;
        color: #333;
        margin-bottom: 20px;
    }

    th, td {
        padding: 8px;
        border: 1px solid #ccc;
        max-width: 200px; /* set maximum width for columns */
        word-wrap: break-word; /* wrap text within columns */
        overflow: auto;
        text-align: center;
    }

    td:nth-child(3) {
        text-align: left;
    }

    th {
        background-color: #f7f7f7;
        font-weight: bold;
    }

    /* CSS rules for the loading indicator */
    .loading-indicator {
        background-color: rgba(255, 255, 255, 0.8); /* semi-transparent white background */
        border-radius: 4px; /* rounded corners */
        color: #333; /* text color */
        font-size: 16px; /* font size */
        padding: 12px; /* padding around the text */
        text-align: center; /* center the text */
        width: 120px; /* width of the loading indicator */
    }

    /* CSS rules for the spinner */
    .spinner {
        border: 3px solid rgba(0, 0, 0, 0.2); /* gray border */
        border-top-color: #333; /* top border color */
        border-radius: 50%; /* rounded shape */
        height: 24px; /* height of the spinner */
        width: 24px; /* width of the spinner */
        -webkit-animation: spin 1s linear infinite; /* CSS animation for the spinner */
        animation: spin 1s linear infinite;
    }

    /* CSS animation for the spinner */
    @-webkit-keyframes spin {
        0% {
            -webkit-transform: rotate(0deg);
        }
        100% {
            -webkit-transform: rotate(360deg);
        }
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    input[type="file"] {
        background-color: #e89b71; /* green background */
        border: none; /* no border */
        color: white; /* white text */
        padding: 12px 24px; /* padding around the text */
        text-align: center; /* center the text horizontally */
        text-decoration: none; /* no underline */
        display: inline-block; /* display as inline block */
        font-size: 16px; /* font size */
        border-radius: 4px; /* rounded corners */
        cursor: pointer; /* change the cursor to a pointer on hover */
        transition: background-color 0.3s ease; /* transition for the background color */
    }

    input[type="file"]:hover {
        background-color: #8e7a3e; /* darker green background on hover */
    }


    .popup {
        background-color: #fff; /* white background */
        border-radius: 4px; /* rounded corners */
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3); /* drop shadow */
        display: none; /* hide the popup by default */
        left: 50%; /* center horizontally */
        position: fixed; /* fixed position */
        top: 50%; /* center vertically */
        transform: translate(-50%, -50%); /* center the popup */
        z-index: 999; /* ensure the popup appears on top */
    }

    /* CSS rules for the popup content */
    .popup-content {
        display: flex; /* use flexbox layout */
        align-items: center; /* center the content vertically */
        justify-content: center; /* center the content horizontally */
        padding: 24px; /* padding around the content */
    }

    /* CSS rules for the backdrop */
    .backdrop {
        background-color: rgba(0, 0, 0, 0.5); /* semi-transparent black background */
        display: none; /* hide the backdrop by default */
        height: 100%; /* cover the entire height of the page */
        left: 0; /* align to the left of the page */
        position: fixed; /* fixed position */
        top: 0; /* align to the top of the page */
        width: 100%; /* cover the entire width of the page */
        z-index: 998; /* ensure the backdrop appears behind the popup */
    }

    /* CSS rules for the spinner */
    .spinner {
        border: 3px solid rgba(0, 0, 0, 0.2); /* gray border */
        border-top-color: #333; /* top border color */
        border-radius: 50%; /* rounded shape */
        height: 24px; /* height of the spinner */
        width: 24px; /* width of the spinner */
        -webkit-animation: spin 1s linear infinite; /* CSS animation for the spinner */
        animation: spin 1s linear infinite;
    }

    /* CSS animation for the spinner */
    @-webkit-keyframes spin {
        0% {
            -webkit-transform: rotate(0deg);
        }
        100% {
            -webkit-transform: rotate(360deg);
        }
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

</style>
<body>
<div class="title">
    <h2>Multiple Predictions</h2>
</div>
<div>
    <form id="upload-form" action="/multiple_prediction" method="POST" enctype="multipart/form-data">
        <label for="select">Select an option:</label>
        <select onchange="changeSelection(event)" id="select" name="select">
            <option value="1">Deep SE method</option>
            <option value="2">GNN RNN method</option>
            <option value="3">GPTSP3</option>
        </select>
        <input type="file" name="file" id="file-input" onchange="handleFileSelect(event);">
        <div id="loading-indicator" class="loading-indicator" style="display:none;">
            <div class="spinner"></div>
            Loading...
        </div>
    </form>

    <div id="popup" class="popup" style="display: none">
        <div class="popup-content">
            <div class="spinner"></div>
            <div class="message">Loading...</div>
        </div>
    </div>

    <div id="backdrop" class="backdrop"></div>
    <div id="csv-data"></div>
</div>
</body>
<script>
    let selection = 1;

    function changeSelection(event) {
        selection = event.target.value
    }

    function displayCsvData(data) {
        let csvDataDiv = document.getElementById('csv-data');
        {#let csvTable = document.createElement('table');#}
        {#let csvRows = data.split('</td>');#}
        {#console.log(csvRows[0])#}
        {#csvTable.innerHTML = data;#}


        let tempDiv = document.createElement('div');
        tempDiv.innerHTML = data;
        let csvTable = tempDiv.querySelector('table');
        let buttonCell = document.createElement('td');
        buttonCell.textContent = 'Click to Predict';
        csvTable.rows[0].appendChild(buttonCell);
        // Create a new row at the end of the table with a button element
        for (let i = 1; i < csvTable.rows.length; i++) {
            // Create a new cell in the row with a button element
            let buttonCell = document.createElement('td');
            let button = document.createElement('button');
            button.textContent = 'Predict';
            buttonCell.appendChild(button);
            csvTable.rows[i].appendChild(buttonCell);

            button.addEventListener('click', function () {

                let myButton = document.getElementById('my-button');
                let popup = document.getElementById('popup');
                let backdrop = document.getElementById('backdrop');
                popup.style.display = 'block';
                backdrop.style.display = 'block';

                let row = this.parentNode.parentNode;
                let storypointCell = row.querySelector('td:nth-child(4)');

                let descriptionCell = row.querySelector('td:nth-child(3)');
                let descriptionValue = descriptionCell.textContent;

                let request = new XMLHttpRequest();
                request.open('POST', 'http://127.0.0.1:5000/userStory?choice=' + selection, true);
                request.setRequestHeader('Content-Type', 'application/json');
                request.onload = function () {
                    if (request.status >= 200 && request.status < 400) {
                        // Success!
                        let data = request.responseText;
                        let val = JSON.parse(data);
                        let storyPoint = val.story_point;
                        storypointCell.textContent = storyPoint;
                        console.log(storyPoint);
                    } else {
                        // We reached our target server, but it returned an error
                    }
                    document.getElementById('loading-indicator').style.display = 'none';
                    popup.style.display = 'none';
                    backdrop.style.display = 'none';
                };
                request.onerror = function () {
                    document.getElementById('loading-indicator').style.display = 'none';
                    popup.style.display = 'none';
                    backdrop.style.display = 'none';
                    // There was a connection error of some sort
                };
                let userStory = {
                    user_story: descriptionValue
                };
                document.getElementById('loading-indicator').style.display = 'block';
                let data = JSON.stringify(userStory);
                request.send(data);


            });
        }
        console.log(csvTable)
        // Append the table to the 'csv-data' div element
        csvDataDiv.appendChild(csvTable);

        let csvButton = document.createElement('button');
        csvButton.textContent = 'Download CSV';
        csvDataDiv.appendChild(csvButton);
        csvButton.addEventListener('click', function () {
            // Convert the HTML table to a CSV string
            let csvData = csvTableToCsv(csvTable);

            // Create a new blob object with the CSV data
            let blob = new Blob([csvData], {type: 'text/csv;charset=utf-8;'});

            // Create a new URL for the blob object
            let url = URL.createObjectURL(blob);

            // Create a new anchor element with the URL as the href attribute
            let downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = 'data.csv';

            // Append the anchor element to the document body and click it to start the download
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        });


        {#csvDataDiv.appendChild(csvTable);#}
    }

    function csvTableToCsv(table) {
        let csvRows = [];

        for (let i = 0; i < table.rows.length; i++) {
            let csvCells = [];
            for (let j = 0; j < table.rows[i].cells.length; j++) {
                csvCells.push(table.rows[i].cells[j].textContent);
            }
            csvRows.push(csvCells.join(','));
        }

        return csvRows.join('\n');
    }

    function handleFileSelect(event) {
        let file = event.target.files[0];
        let formData = new FormData();
        formData.append('file', file);
        console.log(file)
        let xhr = new XMLHttpRequest();
        xhr.open('POST', '/multiple_prediction');
        xhr.onload = function () {
            if (xhr.status === 200) {
                displayCsvData(xhr.responseText);
            } else {
                alert('Error uploading file');
            }
        };
        xhr.send(formData);
    }

</script>
</html>